<!DOCTYPE html>
<html lang="en" xml:lang="en">
    <head>
    <meta charset="UTF-8">
    <title>Tent management dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./styles.css" type="text/css">
    </head>
    <body>
    <div class="container">
        <h1>🌱 ESP Grow Tent Monitor</h1>
        
        <div id="status" class="status offline">
            <span id="statusText">Connecting...</span>
        </div>
        
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-label">🌡️ Air Temperature 1</div>
                <div id="air_temperature_1" class="sensor-value">--°C</div>
                <div id="air_temperature_1F" style="font-size: 1.2em; opacity: 0.8;">--°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">🌡️ Air Temperature 2</div>
                <div id="air_temperature_2" class="sensor-value">--°C</div>
                <div id="air_temperature_2F" style="font-size: 1.2em; opacity: 0.8;">--°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">🌡️ Air Temperature 3</div>
                <div id="air_temperature_3" class="sensor-value">--°C</div>
                <div id="air_temperature_3F" style="font-size: 1.2em; opacity: 0.8;">--°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">🌡️ Air Temperature 4</div>
                <div id="air_temperature_4" class="sensor-value">--°C</div>
                <div id="air_temperature_4F" style="font-size: 1.2em; opacity: 0.8;">--°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">💧 Air Humidity 1</div>
                <div id="air_humidity_1" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">💧 Air Humidity 2</div>
                <div id="air_humidity_2" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">💧 Air Humidity 3</div>
                <div id="air_humidity_3" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">💧 Air Humidity 4</div>
                <div id="air_humidity_4" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">💧 Flood Sensor</div>
                <div id="floodValue" class="sensor-value">--</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">💧 Water Level Sensor</div>
                <div id="waterLevelValue" class="sensor-value">--</div>
            </div>
        </div>
        <div class="sensor-card">
            <div class="sensor-card">
                <div class="sensor-label">🔌 Relays</div>
                <div id="relays">
                    <div>
                        <span id="relayName1">Relay 1</span>: <span class="switch-label">Off</span>
                            <label class="switch" for="relaySw1">
                                <input type="checkbox" id="relaySw1" onchange="setRelayState(0)">
                                <span class="slider"></span>
                            </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName2">Relay 2</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw2">
                            <input type="checkbox" id="relaySw2" onchange="setRelayState(1)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName3">Relay 3</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw3">
                            <input type="checkbox" id="relaySw3" onchange="setRelayState(2)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName4">Relay 4</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw4">
                            <input type="checkbox" id="relaySw4" onchange="setRelayState(3)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName5">Relay 5</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw5">
                            <input type="checkbox" id="relaySw5" onchange="setRelayState(4)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName6">Relay 6</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw6">
                            <input type="checkbox" id="relaySw6" onchange="setRelayState(5)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName7">Relay 7</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw7">
                            <input type="checkbox" id="relaySw7" onchange="setRelayState(6)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="relayName8">Relay 8</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="relaySw8">
                            <input type="checkbox" id="relaySw8" onchange="setRelayState(7)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="config-link" style="text-align: center; margin-bottom: 20px;">
            <a href="./config.html" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 1.1em;">
                ⚙️ Configure
            </a>
        </div>
        
        <div class="last-update">
            Last updated: <span id="lastUpdate">Never</span>
            <span id="loadingSpinner" class="loading" style="display: none; margin-left: 10px;"></span>
        </div>
        
        <div style="text-align: center; margin-top: 15px; opacity: 0.6; font-size: 0.9em;">
            ESP Grow Tent Monitor: Alpha
        </div>
    </div>

        <script>
            let updateInterval;

            function setStatus(online, text) {
                const statusEl = document.getElementById('status');
                const statusText = document.getElementById('statusText');
                statusEl.className = 'status ' + (online ? 'online' : 'offline');
                statusText.textContent = text;
            }

            function cToF(c) {
                if (typeof c !== 'number' || isNaN(c)) return null;
                return (c * 9) / 5 + 32;
            }

            function updateDht22(dht) {
                // dht is an object with keys like "0", "1", ...
                const keys = Object.keys(dht);

                // Map up to 4 sensors into the pre-defined cards
                for (let i = 0; i < 4; i++) {
                    const idx = String(i); // JSON keys are strings
                    const tempEl = document.getElementById('air_temperature_' + (i + 1));
                    const tempFEl = document.getElementById('air_temperature_' + (i + 1) + 'F');
                    const humidEl = document.getElementById('air_humidity_' + (i + 1));

                    if (!tempEl || !humidEl) continue;

                    const cardTempLabel = tempEl.closest('.sensor-card').querySelector('.sensor-label');
                    const cardHumidLabel = humidEl.closest('.sensor-card').querySelector('.sensor-label');

                    if (keys.includes(idx)) {
                        const sensor = dht[idx];
                        const name = sensor.name || `DHT22 Sensor ${idx}`;
                        const t = sensor.temperature;
                        const h = sensor.humidity;

                        if (cardTempLabel) cardTempLabel.textContent = `🌡️ ${name}`;
                        if (cardHumidLabel) cardHumidLabel.textContent = `💧 ${name}`;

                        tempEl.textContent = (typeof t === 'number' && !isNaN(t)) ? `${t.toFixed(1)}°C` : '--°C';
                        if (tempFEl) {
                            const f = cToF(t);
                            tempFEl.textContent = (f !== null) ? `${f.toFixed(1)}°F` : '--°F';
                        }
                        humidEl.textContent = (typeof h === 'number' && !isNaN(h)) ? `${h.toFixed(1)}%` : '--%';
                    } else {
                        // No data for this slot
                        if (cardTempLabel) cardTempLabel.textContent = `🌡️ Air Temperature ${i + 1}`;
                        if (cardHumidLabel) cardHumidLabel.textContent = `💧 Air Humidity ${i + 1}`;
                        tempEl.textContent = '--°C';
                        if (tempFEl) tempFEl.textContent = '--°F';
                        humidEl.textContent = '--%';
                    }
                }
            }

            function updateRelaysIfPresent(data) {
                if (!data || typeof data !== 'object') return;
                const { relays, relayNames } = data;
                if (!Array.isArray(relays) || !Array.isArray(relayNames)) return;
                for (let i = 1; i <= 8; ++i) {
                    const sw = document.getElementById('relaySw' + i);
                    const nameEl = document.getElementById('relayName' + i);
                    if (!sw || !nameEl) continue;
                    if (typeof relays[i] !== 'undefined') sw.checked = !!relays[i];
                    if (typeof relayNames[i] !== 'undefined') nameEl.textContent = relayNames[i];
                }
            }

            function updateSensorData() {
                document.getElementById('loadingSpinner').style.display = 'inline-block';
                fetch('/api/sensors')
                    .then(response => response.json())
                    .then(data => {
                        const dht = data && data.dht22 ? data.dht22 : null;
                        if (dht && Object.keys(dht).length > 0) {
                            updateDht22(dht);
                            updateRelaysIfPresent(data);
                            setStatus(true, '✅ Sensor Online');
                            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                        } else {
                            setStatus(false, '❌ No DHT22 data');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        setStatus(false, '❌ Connection Error');
                    })
                    .finally(() => {
                        document.getElementById('loadingSpinner').style.display = 'none';
                    });
            }

            function setRelayState(idx) {
                let checked = document.getElementById('relaySw' + idx).checked ? 1 : 0;
                let formData = new FormData();
                formData.append('index', idx);
                formData.append('state', checked);
                fetch('/api/relay', { method: 'POST', body: formData })
                    .then(() => updateSensorData());
            }

            function setRelayDefault(idx) {
                let checked = document.getElementById('relayDef' + idx).checked ? 1 : 0;
                let formData = new FormData();
                formData.append('index', idx);
                formData.append('default', checked);
                fetch('/api/relay-default', { method: 'POST', body: formData })
                    .then(() => updateSensorData());
            }

            // Update immediately on page load
            updateSensorData();

            // Update every 15 seconds
            updateInterval = setInterval(updateSensorData, 15000);

            // Update when page becomes visible again
            document.addEventListener('visibilitychange', function () {
                if (!document.hidden) {
                    updateSensorData();
                }
            });
        </script>
    </body>
</html>