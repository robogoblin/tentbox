<!DOCTYPE html>
<html lang="en" xml:lang="en">
    <head>
    <meta charset="UTF-8">
    <title>Tent management dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./styles.css" type="text/css">
    </head>
    <body>
    <div class="container">
        <h1>ğŸŒ± Berry Pi Grow Tent Monitor</h1>
        
        <div id="status" class="status offline">
            <span id="statusText">Connecting...</span>
        </div>
        
        <div class="sensor-grid">
            <div class="sensor-card">
                <div class="sensor-label">ğŸŒ¡ï¸ Air Temperature 1</div>
                <div id="air_temperature_1" class="sensor-value">--Â°C</div>
                <div id="air_temperature_1F" style="font-size: 1.2em; opacity: 0.8;">--Â°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸŒ¡ï¸ Air Temperature 2</div>
                <div id="air_temperature_2" class="sensor-value">--Â°C</div>
                <div id="air_temperature_2F" style="font-size: 1.2em; opacity: 0.8;">--Â°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸŒ¡ï¸ Air Temperature 3</div>
                <div id="air_temperature_3" class="sensor-value">--Â°C</div>
                <div id="air_temperature_3F" style="font-size: 1.2em; opacity: 0.8;">--Â°F</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸ’§ Air Humidity 1</div>
                <div id="air_humidity_1" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸ’§ Air Humidity 2</div>
                <div id="air_humidity_2" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸ’§ Air Humidity 3</div>
                <div id="air_humidity_3" class="sensor-value">--%</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸ’§ Flood Sensor</div>
                <div id="floodValue" class="sensor-value">--</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸ’§ Water Temperature</div>
                <div id="waterTempValue1" class="sensor-value">--Â°C</div>
            </div>
            <div class="sensor-card">
                <div class="sensor-label">ğŸ’§ Water Temperature</div>
                <div id="waterTempValue2" class="sensor-value">--Â°C</div>
            </div>
        </div>
        <div class="sensor-card">
            <div class="sensor-card">
                <div class="sensor-label">ğŸ”Œ Relays</div>
                <div id="relays">
                    <div>
                        <span id="name_plug1">Plug 1</span>: <span class="switch-label">Off</span>
                            <label class="switch" for="plug1">
                                <input type="checkbox" id="plug1" onchange="setRelayState(1)">
                                <span class="slider"></span>
                            </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug2">Plug 2</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug2">
                            <input type="checkbox" id="plug2" onchange="setRelayState(2)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug3">Plug 3</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug3">
                            <input type="checkbox" id="plug3" onchange="setRelayState(3)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug4">Plug 4</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug4">
                            <input type="checkbox" id="plug4" onchange="setRelayState(4)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug5">Plug 5</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug5">
                            <input type="checkbox" id="plug5" onchange="setRelayState(5)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug6">Plug 6</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug6">
                            <input type="checkbox" id="plug6" onchange="setRelayState(6)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug7">Plug 7</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug7">
                            <input type="checkbox" id="plug7" onchange="setRelayState(7)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                    <div>
                        <span id="name_plug8">Plug 8</span>: <span class="switch-label">Off</span>
                        <label class="switch" for="plug8">
                            <input type="checkbox" id="plug8" onchange="setRelayState(8)">
                            <span class="slider"></span>
                        </label>
                        <span class="switch-label">On</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="config-link" style="text-align: center; margin-bottom: 20px;">
            <a href="./config.html" style="color: rgba(255,255,255,0.8); text-decoration: none; font-size: 1.1em;">
                âš™ï¸ Configure
            </a>
        </div>
        
        <div class="last-update">
            Last updated: <span id="lastUpdate">Never</span>
            <span id="loadingSpinner" class="loading" style="display: none; margin-left: 10px;"></span>
        </div>
        
        <div style="text-align: center; margin-top: 15px; opacity: 0.6; font-size: 0.9em;">
            ESP Grow Tent Monitor: Alpha
        </div>
    </div>

        <script>
            let updateInterval;

            function setStatus(online, text) {
                const statusEl = document.getElementById('status');
                const statusText = document.getElementById('statusText');
                statusEl.className = 'status ' + (online ? 'online' : 'offline');
                statusText.textContent = text;
            }

            function cToF(c) {
                if (typeof c !== 'number' || isNaN(c)) return null;
                return (c * 9) / 5 + 32;
            }

            function updateDht22(dhtObj) {
                const entries = Object.entries(dhtObj || {});
                // populate up to 4 cards
                for (let i = 0; i < 3; i++) {
                    const tempEl = document.getElementById('air_temperature_' + (i + 1));
                    const tempFEl = document.getElementById('air_temperature_' + (i + 1) + 'F');
                    const humidEl = document.getElementById('air_humidity_' + (i + 1));
                    const cardTempLabel = tempEl.closest('.sensor-card').querySelector('.sensor-label');
                    const cardHumidLabel = humidEl.closest('.sensor-card').querySelector('.sensor-label');

                    if (i < entries.length) {
                        const [key, sensor] = entries[i];
                        const name = sensor.name || `DHT22 ${key}`;
                        const t = sensor.temperature;
                        const h = sensor.humidity;

                        if (cardTempLabel) cardTempLabel.textContent = `ğŸŒ¡ï¸ ${name}`;
                        if (cardHumidLabel) cardHumidLabel.textContent = `ğŸ’§ ${name}`;

                        tempEl.textContent = (typeof t === 'number' && !isNaN(t)) ? `${t.toFixed(1)}Â°C` : '--Â°C';
                        if (tempFEl) {
                            const f = cToF(t);
                            tempFEl.textContent = (f !== null) ? `${f.toFixed(1)}Â°F` : '--Â°F';
                        }
                        humidEl.textContent = (typeof h === 'number' && !isNaN(h)) ? `${h.toFixed(1)}%` : '--%';
                    } else {
                        // clear slot
                        if (cardTempLabel) cardTempLabel.textContent = `ğŸŒ¡ï¸ Air Temperature ${i + 1}`;
                        if (cardHumidLabel) cardHumidLabel.textContent = `ğŸ’§ Air Humidity ${i + 1}`;
                        tempEl.textContent = '--Â°C';
                        if (tempFEl) tempFEl.textContent = '--Â°F';
                        humidEl.textContent = '--%';
                    }
                }
            }

            function updateDs18b20(ds) {
                const entries = Object.entries(ds || {});
                if (entries.length > 0) {
                    for (let i = 1; i <= 2; i++) {
                        const el = document.getElementById('waterTempValue' + i);
                        if (!el) continue;
                        console.log(`Updating water temperature sensor ${i} with ${JSON.stringify(entries[i])}`);
                        if (i <= entries.length) {
                            const [key, sensor] = entries[i-1];
                            const t = sensor.temperature;
                            const name = sensor.name || key;
                            el.textContent = (typeof t === 'number' && !isNaN(t)) ? `${t.toFixed(2)}Â°C` : '--Â°C';
                            const label = el.closest('.sensor-card').querySelector('.sensor-label');
                            if (label) label.textContent = `ğŸ’§ ${name}`;
                        } else {
                            el.textContent = '--Â°C';
                            const label = el.closest('.sensor-card').querySelector('.sensor-label');
                            if (label) label.textContent = 'ğŸ’§ Water Temperature';
                        }
                    }
                }
            }

            function updateRelays(relays) {
                for (const [id, state] of Object.entries(relays)) {
                    const sw = document.getElementById(id);
                    const nameEl = document.getElementById('name_' + id);
                    if (!sw || !nameEl) continue;
                    sw.checked = state.state;
                    nameEl.textContent = state.name;
                }
            }

            function updateSensorData() {
                document.getElementById('loadingSpinner').style.display = 'inline-block';
                fetch('/api/sensors')
                    .then(response => response.json())
                    .then(data => {
                        const dht = data && data.dht22 ? data.dht22 : null;
                        const ds18b20 = data && data.ds18b20 ? data.ds18b20 : null;
                        const relays = data && data.relays ? data.relays : null;
                        if (dht && Object.keys(dht).length > 0) {
                            updateDht22(dht);
                            updateDs18b20(ds18b20);
                            updateRelays(relays);
                            setStatus(true, 'âœ… Sensor Online');

                            // try to set last update from latest readable_time in payloads
                            let times = [];
                            Object.values(dht || {}).forEach(s => { if (s.readable_time) times.push(s.readable_time); });
                            Object.values(ds18b20 || {}).forEach(s => { if (s.readable_time) times.push(s.readable_time); });
                            const last = times.sort().reverse()[0];
                            document.getElementById('lastUpdate').textContent = last || new Date().toLocaleTimeString();
                        } else {
                            setStatus(false, 'âŒ No DHT22 data');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        setStatus(false, 'âŒ Connection Error');
                    })
                    .finally(() => {
                        document.getElementById('loadingSpinner').style.display = 'none';
                    });
            }

            async function setRelayState(idx) {
                const swId = 'plug' + idx;
                const checked = document.getElementById(swId).checked ? "on" : "off";
                let formData = {
                    'relay_id': swId,
                    'state': checked
                };
                // hang on for a few moments while the cache of state updates.
                
                await fetch('/api/relay/state', { method: 'POST', body: JSON.stringify(formData), headers: { 'Content-Type': 'application/json' } });
            }

            function setRelayDefault(idx) {
                let zeroIdx = (idx >= 1 && idx <= 8) ? (idx - 1) : idx;
                const defId = 'relayDef' + (zeroIdx + 1);
                const checked = document.getElementById(defId) ? (document.getElementById(defId).checked ? 1 : 0) : 0;
                let formData = new FormData();
                formData.append('index', zeroIdx);
                formData.append('default', checked);
                fetch('/api/relay-default', { method: 'POST', body: formData })
                    .then(() => updateSensorData());
            }

            // Update immediately on page load
            updateSensorData();

            // Update every 15 seconds
            updateInterval = setInterval(updateSensorData, 15000);

            // Update when page becomes visible again
            document.addEventListener('visibilitychange', function () {
                if (!document.hidden) {
                    updateSensorData();
                }
            });
        </script>
    </body>
</html>